version: 2.1
commands:
  hello-from-env:
    description: "Say hello"
    steps:
      - run:
          name: "Say hello"
          command: if [ "${VAR}" = "VAR_FROM_ENV" ]; then echo "ENV"; fi
  hello-from-context:
    description: "Say hello"
    steps:
      - run:
          name: "Say hello"
          command: if [ "${VARC}" = "VAR_FROM_CONTEXT" ]; then echo "CONTEXT"; fi
  hello-from-both:
    description: "Say hello"
    steps:
      - run:
          name: "Say hello"
          command: if [ "${VAR}" = "VAR_FROM_CONTEXT" ]; then echo "CONTEXT"; fi
          
  tag-now:
    working_directory: /app
      docker:
        - image: alpine/git:v2.34.1
      steps:
        #- add_ssh_keys:
        #    fingerprints:
        #      - 41:9e:bb:54:d5:b9:31:f0:21:78:15:6a:29:da:9d:55
        - checkout
        - setup_remote_docker
        - run:
            name: Setup name/mail, tag and push tag
             command: |
               git config --global user.name "thibault-deriv"
               git config --global user.email "thibault@deriv.com"
               tag=`date +%s`
               git tag $tag 
               git push origin $tag

jobs:
  from-env:
    docker:
      - image: cimg/node:18.4.0
    steps:
      - checkout
      - hello-from-env
      - tag-now
  from-context:
    docker:
      - image: cimg/node:18.4.0
    steps:
      - checkout
      - hello-from-context
  from-both:
    docker:
      - image: cimg/node:18.4.0
    steps:
      - checkout
      - hello-from-both

workflows:
  from-env:
    jobs:
      - from-env:
          filters:
            branches:
              only: /^main$/
  from-context:
    jobs:
      - from-context:
          filters:
            branches:
              only: /^main$/
          context: mycontext
  from-both:
    jobs:
      - from-both:
          filters:
            branches:
              only: /^main$/
          context: mycontext


